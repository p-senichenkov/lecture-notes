% add file names in logs
\usepackage{structuredlog}

% basics
\usepackage[a4paper, portrait, margin=.75in]{geometry}

\usepackage{fontspec}
\setmainfont{CMU Serif}
\setsansfont{CMU Sans Serif}
\setmonofont{CMU Typewriter Text}

% for the \mathscr command
\usepackage{mathrsfs}

\usepackage{polyglossia}
\setmainlanguage{russian}
\setotherlanguage{english}
% \setkeys{russian}{babelshorthands=true, mathfunctions=true}

\usepackage{ifthen}

%% polyglossia shorthands:
%   "-   -- additional hypen point, does *not* disable others
%   ""   -- *allows* linebrak, *without* hypen sign
%   "--- -- normal dash ( -- )
%   "--~ -- dash for compound names (--)
%   "--* -- dash for direct speech (--  )

% custom \chapter and \section formats
\usepackage{titlesec}

% references in table of contents
\usepackage{hyperref}
\hypersetup{
    colorlinks=true, %set true if you want colored links
    linktoc=all,     %set to all if you want both sections and subsections linked
    linkcolor=black, %choose some color if you want links to stand out
}
\urlstyle{same}      % links will be the same font as other text

% russian names for autoref:
\AtBeginDocument{\renewcommand\figureautorefname{рис.}}
\AtBeginDocument{\renewcommand\theoremautorefname{теор.}}
\AtBeginDocument{\renewcommand\lemmaautorefname{лемма}}
\AtBeginDocument{\renewcommand\definitionautorefname{опр.}}
\AtBeginDocument{\renewcommand\statementautorefname{утв.}}

% BibTeX month names:
% \def\bbljan{Jan}
% \def\bblfeb{Feb}
% \def\bblmar{Mar}
% \def\bblapr{Apr}
% \def\bblmay{May}
% \def\bbljun{Jun}
% \def\bbljul{Jul}
% \def\bblaug{Aug}
% \def\bblsep{Sep}
% \def\bbloct{Oct}
% \def\bblnov{Nov}
% \def\bbldec{Dec}

\usepackage{graphicx}
\usepackage{multicol}
\usepackage[dvipsnames]{xcolor}

% additional matrix features
% not so fast; consider not using a lot
\usepackage{nicematrix}

% \set and \braket
\usepackage{braket}

% fancy vectors
\usepackage[e]{esvect}

% space that doesn't disappear at the end of text commands, but is ommited when needed (e. g. before comma)
\usepackage{xspace}

% typeset pseudocode (algo2e option -- change env. name algorithm to algorithm2e)
\usepackage[algo2e]{algorithm2e}

% algorithm2e keywords:
\SetKw{Define}{:=}

% sections with separate PDF bookmark and toc form
\usepackage{hypbmsec}

% subequations
\usepackage[ntheorem]{empheq}

\usepackage{amsmath, amsfonts, mathtools, amsthm, amssymb}

% diagonal lines through items ("cancelling" 'em)
\usepackage{cancel}

% for \lightning (should be loaded *before* bm)
\usepackage[only,lightning]{stmaryrd}

% https://tex.stackexchange.com/questions/106714/stmaryrd-and-boldsymbol-avoid-warnings
\SetSymbolFont{stmry}{bold}{U}{stmry}{m}{n}

\usepackage{tikz}
\usetikzlibrary{intersections, angles, arrows.meta, decorations.pathreplacing, quotes, positioning, chains}

% multiple images in one figure
\usepackage{subcaption}

% figure, wrapped in text
\usepackage{wrapfig}

% fractions like 2/a and faktorgroups
\usepackage{faktor}

% xlongequal
\usepackage{extarrows}

% requires LuaLaTeX
% \usepackage{emoji}

% bold font in maths, that preserve spacing (should be loaded *last*)
\usepackage{bm}

%%      math operators
% distance
\DeclareMathOperator{\dist}{dist}

% constant
\DeclareMathOperator{\const}{const}

% matrix rank
\DeclareMathOperator{\rk}{rk}

% image
\DeclareMathOperator{\Img}{Im}

% order of something
\DeclareMathOperator{\ord}{ord}

% differential
\newcommand\di[1][]{\ensuremath{\operatorname{d}^{#1}}}

% sign
\DeclareMathOperator{\sign}{sign}

% ring's characteristics
\DeclareMathOperator{\chara}{char}

%%      numerating
% labeled equation
\newenvironment{equ}[1]{\begin{equation} \label{eq:#1}}{\end{equation}}
% shorthands for multline (FIXME: don't work fine):
\newenvironment{ml}[1]{\begin{multline} \label{eq:#1}}{\end{multline}}
\newenvironment{ml*}{\begin{multline*}}{\end{multline*}}
% multiline equation with *every* line numbered
\newenvironment{mequ}[1][\empheqlbrace]
{
    \setkeys{EmphEqEnv}{align} \setkeys{EmphEqOpt}{left={#1}} \EmphEqMainEnv
}
{\endEmphEqMainEnv}

% variants
\newenvironment{vars}{\left[\begin{array}{l}}{\end{array}\right.}

%%      KaTeX
\newcommand\sub{\ensuremath\subset}

\newcommand\exist{\exists\,}

%%      shorthands
% phi and epsilon
\let\vphi\varphi
\let\veps\varepsilon

% small triangle
\let\vtri\vartriangle

%% over-decorations
\let\ol\overline
\let\vawe\widetilde
% long \vec (DEPRECATED)
\newcommand*\vect[1]{\overrightarrow{#1}}
% long \vec (DEPRECATED -- use \vv and \vv*)
\AtBeginDocument{\renewcommand\vec\vv}
% long hat
\newcommand\smallhat\hat
\AtBeginDocument{\renewcommand\hat\widehat}

% ?=
\newcommand\iseq{\stackrel?=}

% not in
\let\nin\notin

%%    font style
% math
\newcommand\mc\mathcal
\newcommand\msc\mathscr
\newcommand\ttm\mathtt

% text
\newcommand\bt\textbf
\AtBeginDocument{\renewcommand\it\textit}

% n-th partial derivative
\newcommand*\pder[2]{\ensuremath{\frac{\partial {#1}}{\partial {#2}}}}

% n-th derivative
\newcommand*\nder[2][n]{\ensuremath{{#2}^{({#1})}}}

%%    arrows

% arrows with text below `em
\newcommand\underarr[1]{\ensuremath\xrightarrow[#1]{}}
\newcommand\underimp[1]{\ensuremath\xRightarrow[#1]{}}
\newcommand\underiff[1]{\ensuremath\xLeftrightarrow[#1]{}}

% arrows with text above `em
\newcommand\overarr[1]{\ensuremath\xrightarrow{#1}}

% not-arrows with text below `em
\newcommand\undereq[1]{\ensuremath\xlongequal[#1]{}}

\makeatletter
\let\equiv@\equiv
\newcommand\@equiv[1][]{\overset{#1}\equiv@}
\let\equiv\@equiv
\makeatother

% custom extensible arrows
\makeatletter
% xrightrightarrow
\newdimen\@temp
\settowidth\@temp{$ \m@th \relbar $}
\def\@highRelbar{\raisebox{-0.1675em}{$ \relbar $}\hspace{-\@temp}\raisebox{0.1675em}{$ \relbar $}}
\def\xrightrightarrowsfill@{\arrowfill@\@highRelbar\@highRelbar\rightrightarrows}
\newcommand\xrightrightarrows[2][]{\ext@arrow 0099\xrightrightarrowsfill@{#1}{#2}}

% xequiv
\let\equv@\equiv
\newcommand\xequivfill@{\arrowfill@\equiv@\equiv@\equiv@}
\newcommand\xequiv[2][]{\ext@arrow 0099\xequivfill@{#1}{#2}}
% equiv with domain
\AtBeginDocument{\renewcommand\equiv[1][]{\xequiv{#1}}}

\makeatother

% special cases
\newcommand\limarr[2]{\ensuremath\underarr{{#1} \to {#2}}}
\newcommand\infarr[1]{\ensuremath\limarr{#1}\infty}
\newcommand\zarr[1]{\ensuremath\limarr{#1}0}
\newcommand\uniarr[2][n \to \infty]{\ensuremath\xrightrightarrows[#1]{#2}}

% other custom arrows

\newcommand\curveddownarrowright{\rotatebox{180}{$ \curvearrowleft $}}
\newcommand\curveddownarrowleft{\rotatebox{180}{$ \curvearrowright $}}

% 1 is left-to-right
\newcommand\curvedir[2][1]{\ifthenelse{\isodd{#1}}
    {\ensuremath{\overset{\curveddownarrowright}{#2}}}
    {\ensuremath{\overset{\curveddownarrowleft}{#2}}}}

% labels and references
\newcommand*\lbl[1]{\label{eq:#1}}
\newcommand*\eref[1]{\eqref{eq:#1}}

% limits
\newcommand\ulim{\ensuremath{\varlimsup\limits}}
\newcommand\dlim{\ensuremath{\varliminf\limits}}

\newcommand\liml[1]{\lim\limits_{#1}}
\newcommand\limz[1]{\lim\limits_{#1\to0}}
\newcommand\limi[1]{\lim\limits_{#1\to\infty}}

%%    integrals
% undefined
\newcommand\uint[2][x]{\ensuremath{\int {#2} \, \operatorname{d} {#1}}}
\newcommand\ufint[2][x]{ \ensuremath{ \int{ \dfrac{\operatorname{d} {#1}}{{#2}} } } }

% defined
\newcommand\dint[4][x]{\ensuremath{\int_{#2}^{#3} {#4} \, \operatorname{d} {#1}}}
\newcommand\dfint[4][x]{\ensuremath{\int_{#2}^{#3} \dfrac{\operatorname{d} {#1}}{{#4}}}}

% curve (and other figures)
\newcommand\cint[3][l(M)]{\ensuremath{\int\limits_{#2} {#3} \, \operatorname{d} {#1}}}
\newcommand\acint[3][z]{\ensuremath{\int\limits_{#2} {#3} \, |\operatorname{d} {#1}|}}

% "short" integral
\newcommand\sint[2][x]{\ensuremath{\int {#2} \, \operatorname{d} {#1}}}

% comparable by modulo
\newcommand*\comp[1]{\ensuremath{\underset{#1}{\equiv}}}

%% definition:
% :=
\newcommand\define\coloneqq
% =:
\newcommand\fed\eqqcolon
% :{#1}
\newcommand*\definerel[1]{\mathrel{:{#1}}}
% by definition (default is =)
\newcommand*\bydef[1][=]{\ensuremath{\stackrel{\operatorname{def}}{#1}}}
% by definition with NECESSARY text:
\newcommand*\bdef[2][=]{\ensuremath{\stackrel{\operatorname{def}{#2}}{#1}}}

\newcommand*\bdefeq[1]{\ensuremath{\xlongequal{\operatorname{def}{#1}}}}
\newcommand*\bdefimp[1]{\ensuremath{\xRightarrow{\operatorname{def} {#1}}}}

% sets:
\newcommand\N{\ensuremath{\mathbb{N}}}
\newcommand\R{\ensuremath{\mathbb{R}}}
\newcommand\Z{\ensuremath{\mathbb{Z}}}
\renewcommand\O{\ensuremath{\emptyset}}
\newcommand\Q{\ensuremath{\mathbb{Q}}}
\newcommand\Co{\ensuremath{\mathbb{C}}}     % because /C is already taken
\newcommand\Prime{\ensuremath{\mathbb{P}}}     % prime numbers
\newcommand\On[1][n]{\ensuremath{\mathbb{O}_{#1}}}  % (0, ..., 0)

% a line of dots (3em by default) (not desired -- use \dots wherewher possible)
% https://tex.stackexchange.com/a/332124/358925
\newcommand\widedots[1][3em]{\makebox[#1]{\dotfill}}

% sequence
\newcommand\seq[3][\infty]{\ensuremath{\Set{#2}_{#3=1}^{#1}}}
\newcommand\seqz[3][\infty]{\ensuremath{\Set{#2}_{#3=0}^{#1}}}
\newcommand\seqv[4][\infty]{\ensuremath{\Set{#2}_{#3={#4}}^{#1}}}

% column
\newcommand\column[3][bmatrix]{\ensuremath{
        \begin{#1}
            {#2} \\
            \vdots \\
            {#3}
        \end{#1}
    }}

% clamp function
\newcommand\clamp[2][]{\ensuremath{\big|_{#2}^{#1}}}

% continuous function
\newcommand\Cont[2][]{\ensuremath{\mathcal{C}^{#1} \big( {#2} \big) }}

% norm in R^n
\newcommand\norm[1]{\ensuremath{\left\|{#1}\right\|}}

%%  russian non-breaking abbrevations
\newcommand\as{\text{т.~к.}\xspace}
\newcommand\As{\text{Т.~к.}\xspace}
\newcommand\ie{\text{т.~е.}\xspace}
% so-called
\newcommand\soc{\text{т.~н.}\xspace}

%%      decorations
% divisible by
\DeclareRobustCommand{\divby}{%
  \mathrel{\vbox{\baselineskip.65ex\lineskiplimit0pt\hbox{.}\hbox{.}\hbox{.}}}%
}

% not divisible by
\DeclareRobustCommand{\ndivby}{%
  \mathrel{\not\vbox{\baselineskip.65ex\lineskiplimit0pt\hbox{.}\hbox{.}\hbox{.}}}%
}

% controversy
\newcommand\contra{~\scalebox{1.2}{$\lightning$}~}

% roman numbers
\makeatletter
\newcommand*{\rom}[1]{\text{\expandafter\@slowromancap\romannumeral #1@}}
\makeatother

% triangle inequality
\newcommand\trile{\ensuremath{\stackrel\vartriangle\le}}
\newcommand\trige{\ensuremath{\stackrel\vartriangle\ge}}

% math &
\newcommand\amp{\ensuremath{\mathrel\&}}

\newcommand\TODO[1]{\textcolor{red}{{\Huge TODO:} {#1}} \message{LaTeX Warning: TODO on line \the\inputlineno%
%
}}

\newcommand\comment[1]{\textcolor{magenta}{\textit{#1}}}

% "not important" (FIXME: remove default value)
\newcommand\nimp[1][\text{если не оговорено иное}]{\textcolor{gray}{#1}}

%%     \section
% "math string"
\newcommand\mstring[1]{\texorpdfstring{$ {#1} $}{#1}}
% \\
\newcommand\n{\texorpdfstring\\{}}

% polyglossia shorthands (XXX: does this work fine?)
\AtBeginDocument{\newcommand\compname{\texorpdfstring{"--~}{--}}}

\newcommand\tcir\textasciicircum
\newcommand\tpst\texorpdfstring

%% set package shorthands
\let\tset\set
\let\set\Set

\let\tbraket\braket
\let\braket\Braket

% vector-argument of function
\newenvironment{barg}{\left(\begin{bmatrix}}{\end{bmatrix}\right)}

% make dotted lines semi-transparent by default in nicematrix
\NiceMatrixOptions{xdots/line-style=loosely dotted, nullify-dots}

% some special cases of nicematrix (pretty slow)
\newcommand\diagmatrix[3][0]{
    \begin{pNiceMatrix}
        {#2} & \Block[r]{2-2}<\LARGE>{#1} & \\
		\Block[l, b]{2-2}<\LARGE>{#1} & \Ddots & \\
        & & {#3}
	\end{pNiceMatrix}
}

%%     Basov
% Basov's "antlers" -- two cases (XXX: get rid of this)
\newcommand\commonantlers[2]{\vspace{-2em}
\begin{figure}[h]
    	\centering
        \begin{tikzpicture}
        	\draw[->, name path=antler-1] (0, 0) -- (2, -0.5);
            \path[name path=vert-1] (1, -0.5) -- (1, 0);
            \node[name intersections={of=antler-1 and vert-1}] at (intersection-1)[above]{#2};

            \draw[->, name path=antler-2] (0, 0) -- (-2, -0.5);
            \path[name path=vert-2] (-1, -0.5) -- (-1, 0);
            \node[name intersections={of=antler-2 and vert-2}] at (intersection-1)[above]{#1};
        \end{tikzpicture}
    \end{figure}\vspace{-2em}}
\newcommand\antlers{\commonantlers{}{}}
\newcommand\antlersimp{\commonantlers{}{\textcolor{red}{!!!}}}

% Cauchy's problem
\newcommand\caupr[2][]{$ \text{ЗК}_{\ensuremath{#1}}(#2) $}

%%     theorems
\usepackage{thmtools, thm-restate}
\usepackage[framemethod=TikZ]{mdframed}
\mdfsetup{skipabove=.5em, skipbelow=0em}

\theoremstyle{definition}

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{ForestGreen!70!black}, bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=ForestGreen, backgroundcolor=ForestGreen!5,
    }
]{thmgreenbox}

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{NavyBlue!70!black}, bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=NavyBlue, backgroundcolor=NavyBlue!5,
    }
]{thmbluebox}

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{NavyBlue!70!black}, bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=NavyBlue
    }
]{thmblueline}

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{RawSienna!70!black}, bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=RawSienna, backgroundcolor=RawSienna!5,
    }
]{thmredbox}

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{RawSienna!70!black}, bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=RawSienna, backgroundcolor=RawSienna!2.5
    }
]{thmredline}

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{RawSienna!70!black}, bodyfont=\normalfont,
    numbered=no,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=RawSienna, backgroundcolor=RawSienna!1,
    },
    qed=\qedsymbol
]{thmproofbox}

\newcommand\chevron{\square\hspace{-0.82em}\raisebox{0.41em}{\resizebox{0.85em}{0.25em}{\triangledown}}}

\declaretheoremstyle[
    headfont=\bfseries\sffamily,
    bodyfont=\normalfont,
    numbered=yes,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=Black, backgroundcolor=Black!1,
    },
    qed=\chevron
]{thproblembox}

\declaretheorem[style=thmgreenbox, name=Определение]{definition}

\declaretheorem[style=thmbluebox, numbered=no, name=Пример]{eg}
\declaretheorem[style=thmbluebox, numbered=no, name=Примеры]{egs}
\declaretheorem[style=thmbluebox, numbered=no, name=Свойство]{property}
\declaretheorem[style=thmbluebox, numbered=no, name=Свойства]{properties}
\declaretheorem[style=thmbluebox, numbered=no, name=Алгоритм]{algorithm}
\declaretheorem[style=thmbluebox, name=Вопрос]{quest}

\declaretheorem[style=thmredbox, name=Теорема]{theorem}
\declaretheorem[style=thmredbox, name=Лемма]{lemma}
\declaretheorem[style=thmredbox, name=Утверждение]{statement}
\declaretheorem[style=thmredbox, name=Аксиома]{axiom}
\declaretheorem[style=thmredbox, numbered=no, name=Утверждения]{statements}
\declaretheorem[style=thmredbox, numbered=no, name=Следствие]{implication}
\declaretheorem[style=thmredbox, numbered=no, name=Вывод]{corollary}

\declaretheorem[style=thmredline, numbered=no, name=Другая формулировка]{restatebase}

\newenvironment{restate}{\vspace{-.5em}\begin{restatebase}}{\end{restatebase}}

\declaretheorem[style=thmblueline, numbered=no, name=Замечание]{remark}
\declaretheorem[style=thmblueline, numbered=no, name=Примечание]{note}

% Basov's control point. It's green, because it's commonly used inside of algorithm, which is blue (XXX)
\declaretheorem[style=thmgreenbox, numbered=no, name=Контрольная точка]{control}
\declaretheorem[style=thmgreenbox, numbered=no, name=Ответ]{answerbase}

\declaretheorem[style=thproblembox, name=Задача]{problem}

% numbered theorems
\newenvironment{props}[1][ ]{\begin{properties}[{#1}]\hfill\begin{enumerate}}{\end{enumerate}\end{properties}}
\newenvironment{stmts}[1][ ]{\begin{statements}[{#1}]\hfill\begin{enumerate}}{\end{enumerate}\end{statements}}
\newenvironment{exmpls}[1][ ]{\begin{egs}[{#1}]\hfill\begin{enumerate}}{\end{enumerate}\end{egs}}
\newenvironment{algo}[1][ ]{\begin{algorithm}[{#1}]\hfill\begin{enumerate}}{\end{enumerate}\end{algorithm}}

\newenvironment{iproof}[1][ ]{\begin{proof}[{#1}]\hfill\begin{itemize}}{\end{itemize}\end{proof}}
\newenvironment{eproof}[1][ ]{\begin{proof}[{#1}]\hfill\begin{enumerate}}{\end{enumerate}\end{proof}}

\declaretheorem[style=thmproofbox, name=Доказательство]{replacementproof}
% proof, moved 0.5em up
\renewenvironment{proof}{\vspace{-.5em}\begin{replacementproof}}{\end{replacementproof}}

\declaretheorem[style=thmproofbox, name=Без доказательства]{noproofbase}
% Reasons go inside
\newenvironment{noproof}{\vspace{-.5em}\begin{noproofbase}}{\end{noproofbase}}

\newenvironment{answer}{\vspace{-.5em}\begin{answerbase}}{\end{answerbase}}

% no-style theorems
\newtheorem*{notation}{Обозначение}
\newtheorem*{intuition}{Очевидно, что}
\newtheorem*{remind}{Напоминание}

%%    ``undefined theorem'' -- theorem-like environment with custom header

\newmdenv[linewidth=2pt, rightline=false, topline=false, bottomline=false, linecolor=black, backgroundcolor=black!2]{undefinedtheorem}

\newenvironment{undefthm}[1]{\begin{undefinedtheorem}\textbf{#1 }}{\end{undefinedtheorem}}

% markdown quote
\newmdenv[linewidth=2pt, rightline=false, topline=false, bottomline=false, linecolor=black!25,
backgroundcolor=black!2]{mquote}
